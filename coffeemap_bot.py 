#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CoffeeMap Telegram Bot - MVP
–ë–æ—Ç –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∫–æ—Ñ–µ–µ–Ω –≤ –ú–æ—Å–∫–≤–µ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º
"""

import os
import logging
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ConversationHandler,
    ContextTypes,
    filters,
)

# Logging configuration
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# States for conversation flow
START, SCENARIO_SELECTION, RESULTS = range(3)

# Coffee database
COFFEES = {
    '—Ä–∞–±–æ—Ç–∞': [
        {
            'name': 'Coffeeshop Company',
            'location': '–õ—É–±—è–Ω–∫–∞',
            'desc': 'Wi-Fi, —Ä–æ–∑–µ—Ç–∫–∏, —Å—Ç–æ–ª—ã –¥–ª—è –Ω–æ—É—Ç–±—É–∫–∞'
        },
        {
            'name': 'Double B Coffee',
            'location': '–ö—Ä–∞—Å–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞',
            'desc': '—Å–ø–æ–∫–æ–π–Ω–∞—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞, –¥–æ–ª–≥–∏–µ —Å–∏–¥–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è'
        },
        {
            'name': 'Coffee Like',
            'location': '–õ—É–±—è–Ω–∫–∞',
            'desc': '–ø—Ä–æ—Å—Ç–æ—Ä–Ω—ã–µ —Å—Ç–æ–ª—ã, –æ—Ç–ª–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç'
        },
        {
            'name': 'Brew Brothers',
            'location': '–¢–≤–µ—Ä—Å–∫–∞—è',
            'desc': '—Ç–∏—Ö–æ–µ –º–µ—Å—Ç–æ, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ñ–æ–∫—É—Å–∞'
        },
        {
            'name': 'Phill & Co Coffee',
            'location': '–ö—É—Ç—É–∑–æ–≤—Å–∫–∞—è',
            'desc': '—Å–≤–µ—Ç–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ, –º–Ω–æ–≥–æ —Ä–æ–∑–µ—Ç–æ–∫'
        }
    ],
    '–≤—Å—Ç—Ä–µ—á–∞': [
        {
            'name': 'Surf Coffee',
            'location': '–ß–∏—Å—Ç—ã–µ –ø—Ä—É–¥—ã',
            'desc': '–ø—Ä–æ—Å—Ç–æ—Ä–Ω–æ, —É–¥–æ–±–Ω–∞—è —Ä–∞—Å—Å–∞–¥–∫–∞ –¥–ª—è –≤—Å—Ç—Ä–µ—á'
        },
        {
            'name': 'Coffee Like',
            'location': '–ê—Ä–±–∞—Ç',
            'desc': '–∂–∏–≤–∞—è –º—É–∑—ã–∫–∞, —Ö–æ—Ä–æ—à–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤'
        },
        {
            'name': 'Black Star Burger Cafe',
            'location': '–ú–∞—è–∫–æ–≤—Å–∫–∞—è',
            'desc': '–º–Ω–æ–≥–æ —Å—Ç–æ–ª–æ–≤, —É–¥–æ–±–Ω–æ —Å–∏–¥–µ—Ç—å –≥—Ä—É–ø–ø–æ–π'
        },
        {
            'name': 'Brew Brothers',
            'location': '–ë–æ–ª—å—à–∞—è –ù–∏–∫–∏—Ç—Å–∫–∞—è',
            'desc': '–æ—Ç–∫—Ä—ã—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –ª–∞–π–≤-—Å–æ–±—ã—Ç–∏—è'
        },
        {
            'name': 'Coffeeshop Company',
            'location': '–ü—É—à–∫–∏–Ω—Å–∫–∞—è',
            'desc': '—Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è'
        }
    ],
    '—Å–µ–±—è': [
        {
            'name': 'Black Star Burger Cafe',
            'location': '–ú–∞—è–∫–æ–≤—Å–∫–∞—è',
            'desc': '—É—é—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—å–µ—Ä, –∫–ª–∞—Å—Å–Ω–∞—è –º—É–∑—ã–∫–∞'
        },
        {
            'name': 'Phill & Co Coffee',
            'location': '–ö—É—Ç—É–∑–æ–≤—Å–∫–∞—è',
            'desc': '—Å–≤–µ—Ç–ª–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ, —Å–ø–æ–∫–æ–π–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞'
        },
        {
            'name': 'Brew Coffee',
            'location': '–ü–æ–ª—è–Ω–∫–∞',
            'desc': '–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω, —Ä–µ–ª–∞–∫—Å–∏—Ä—É—é—â–∞—è –º—É–∑—ã–∫–∞'
        },
        {
            'name': 'Surf Coffee',
            'location': '–ö—Ä–∞—Å–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞',
            'desc': '–ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —É–≥–æ–ª–∫–∏, —Ö–æ—Ä–æ—à–æ –¥–ª—è –º–µ–¥–∏—Ç–∞—Ü–∏–∏'
        },
        {
            'name': 'Double B Coffee',
            'location': '–¶–≤–µ—Ç–Ω–æ–π –±—É–ª—å–≤–∞—Ä',
            'desc': '—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—å–µ—Ä, –º–æ–ª–æ–¥–µ–∂–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞'
        }
    ]
}

# Scenario button mapping
SCENARIO_NAMES = {
    'üíª –î–ª—è —Ä–∞–±–æ—Ç—ã': '—Ä–∞–±–æ—Ç–∞',
    'ü§ù –î–ª—è –≤—Å—Ç—Ä–µ—á–∏': '–≤—Å—Ç—Ä–µ—á–∞',
    '‚òï –î–ª—è —Å–µ–±—è': '—Å–µ–±—è'
}


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω"""
    user = update.effective_user
    logger.info(f"User {user.id} started the bot")

    welcome_text = (
        "–ü—Ä–∏–≤–µ—Ç! ‚òï\n"
        "CoffeeMap –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –∫–æ—Ñ–µ–π–Ω—é –≤ –ú–æ—Å–∫–≤–µ –ø–æ–¥ —Ç–≤–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π.\n"
        "–í—ã–±–µ—Ä–∏, –¥–ª—è —á–µ–≥–æ —Ç—ã –∏—â–µ—à—å –º–µ—Å—Ç–æ üëá"
    )

    keyboard = [['üîç –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫']]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)

    await update.message.reply_text(welcome_text, reply_markup=reply_markup)
    return START


async def start_search(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É —Å—Ü–µ–Ω–∞—Ä–∏—è"""
    user = update.effective_user
    logger.info(f"User {user.id} pressed 'Start search'")

    scenario_text = "–í—ã–±–µ—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π:"

    keyboard = [
        ['üíª –î–ª—è —Ä–∞–±–æ—Ç—ã'],
        ['ü§ù –î–ª—è –≤—Å—Ç—Ä–µ—á–∏'],
        ['‚òï –î–ª—è —Å–µ–±—è']
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)

    await update.message.reply_text(scenario_text, reply_markup=reply_markup)
    return SCENARIO_SELECTION


async def scenario_selected(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è ‚Üí –≤—ã–≤–æ–¥ –∫–æ—Ñ–µ–µ–Ω"""
    user_input = update.message.text
    user = update.effective_user

    scenario_key = SCENARIO_NAMES.get(user_input)

    if not scenario_key:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ üëÜ")
        return SCENARIO_SELECTION

    logger.info(f"User {user.id} selected: {scenario_key}")

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞
    with open('coffee_map_log.txt', 'a', encoding='utf-8') as f:
        f.write(f"User {user.id} ({user.first_name}): {scenario_key}\n")

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    result_text = f"‚òï –í–æ—Ç –∫–æ—Ñ–µ–π–Ω–∏ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è ¬´{scenario_key}¬ª:\n\n"

    for coffee in COFFEES[scenario_key]:
        result_text += f"<b>{coffee['name']}</b> ({coffee['location']})\n"
        result_text += f"‚Äî {coffee['desc']}\n\n"

    await update.message.reply_text(result_text, parse_mode='HTML')

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"
    keyboard = [['üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ']]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)

    await update.message.reply_text("–•–æ—á–µ—à—å –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π?", reply_markup=reply_markup)
    return RESULTS


async def restart(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ö–Ω–æ–ø–∫–∞ '–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ'"""
    user = update.effective_user
    logger.info(f"User {user.id} pressed 'Restart'")

    scenario_text = "–í—ã–±–µ—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π:"

    keyboard = [
        ['üíª –î–ª—è —Ä–∞–±–æ—Ç—ã'],
        ['ü§ù –î–ª—è –≤—Å—Ç—Ä–µ—á–∏'],
        ['‚òï –î–ª—è —Å–µ–±—è']
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)

    await update.message.reply_text(scenario_text, reply_markup=reply_markup)
    return SCENARIO_SELECTION


async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:

    await update.message.reply_text(
        "–Ø –ø–æ–∫–∞ –ø–æ–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ üôÇ\n"
        "–ù–∞–∂–º–∏ ¬´üîç –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫¬ª –∏–ª–∏ /start –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.",
        reply_markup=ReplyKeyboardRemove()
    )


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞"""
    await update.message.reply_text(
        "–î–∏–∞–ª–æ–≥ –æ—Ç–º–µ–Ω—ë–Ω. –ù–∞–ø–∏—à–∏ /start –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.",
        reply_markup=ReplyKeyboardRemove()
    )
    return ConversationHandler.END

def main() -> None:
    """Start the bot"""
    import os
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        raise ValueError("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

    application = Application.builder().token(token).build()

    # Conversation handler
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            START: [MessageHandler(filters.Regex('^üîç –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫$'), start_search)],
            SCENARIO_SELECTION: [
                MessageHandler(
                    filters.Regex('^(üíª –î–ª—è —Ä–∞–±–æ—Ç—ã|ü§ù –î–ª—è –≤—Å—Ç—Ä–µ—á–∏|‚òï –î–ª—è —Å–µ–±—è)$'),
                    scenario_selected
                ),
            ],
            RESULTS: [MessageHandler(filters.Regex('^üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ$'), restart)],
        },
        fallbacks=[
            CommandHandler('cancel', cancel),
            CommandHandler('start', start),
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text),
        ],
    )

    application.add_handler(conv_handler)

    logger.info("ü§ñ CoffeeMap Bot started!")
    application.run_polling()


if __name__ == '__main__':
    main()
